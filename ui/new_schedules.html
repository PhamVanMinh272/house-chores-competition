
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create House Chore Schedule</title>

  <!-- Bootstrap CSS (v5.x) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      background: #f8fafc;
    }
    .card {
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
    }
    .form-help {
      font-size: 0.875rem;
      color: #6c757d;
    }
    .required::after {
      content: " *";
      color: #dc3545;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
    <div class="container">
      <a>#House Chores</a>
      <div class="ms-auto">
        <a href="http://localhost:63342/house-chores-competition/ui/schedules.html"> View Schedule List</a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-xl-7">
        <div class="card">
          <div class="card-header bg-white">
            <h1 class="h4 mb-0">Create a Schedule</h1>
          </div>
          <div class="card-body">
            <!-- Alerts -->
            <div id="alert-container" class="mb-3" aria-live="polite"></div>

            <form id="schedule-form" novalidate>
              <!-- Schedule Date (calendar) -->
              <div class="mb-3">
                <label class="form-label required" for="scheduleDate">Schedule Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="scheduleDate"
                  name="scheduleDate"
                  required
                />
              </div>

              <!-- Chore: optional text with autocomplete (datalist) -->
              <div class="mb-3">
                <label class="form-label" for="choreName">Chore</label>
                <input
                  type="text"
                  class="form-control"
                  id="choreName"
                  name="choreName"
                  placeholder="Type to search or create a new chore (optional)"
                  list="choresList"
                  aria-describedby="choreHelp"
                />
                <datalist id="choresList"></datalist>

                <!-- Hidden: selected choreId if the typed name matches an existing chore -->
                <input type="hidden" id="choreId" name="choreId" />

                <div id="choreHelp" class="form-text">
                  Choose an existing chore from suggestions or enter a new one. Leave empty to skip assigning a chore.
                </div>
              </div>

              <!-- Member select -->
              <div class="mb-3">
                <label class="form-label required" for="memberId">Member</label>
                <select class="form-select" id="memberId" name="memberId" required disabled>
                  <option value="">Loading membersâ€¦</option>
                </select>
              </div>

              <!-- Collapsible Advanced Options -->
              <p>
                <a class="btn btn-link" data-bs-toggle="collapse" href="#advancedOptions" role="button" aria-expanded="false" aria-controls="advancedOptions">
                  Show Advanced Options
                </a>
              </p>

              <div class="collapse" id="advancedOptions">
                <!-- Point (optional) -->
                <div class="mb-3">
                  <label class="form-label" for="point">Point (optional)</label>
                  <input
                    type="number"
                    inputmode="numeric"
                    class="form-control"
                    id="point"
                    name="point"
                    placeholder="Leave empty for None"
                    min="0"
                    step="1"
                  />
                </div>

                <!-- Status (default Pending) -->
                <div class="mb-3">
                  <label class="form-label" for="status">Status</label>
                  <input
                    type="text"
                    class="form-control"
                    id="status"
                    name="status"
                    value="Pending"
                    readonly
                  />
                  <div class="form-text form-help">
                    Status defaults to <strong>Pending</strong>.
                  </div>
                </div>

                <!-- Comment (optional) -->
                <div class="mb-3">
                  <label class="form-label" for="comment">Comment (optional)</label>
                  <textarea
                    class="form-control"
                    id="comment"
                    name="comment"
                    rows="3"
                    placeholder="Add a note (optional)"
                  ></textarea>
                </div>
              </div>

              <!-- Actions -->
              <div class="d-flex gap-2">
                <button id="submitBtn" type="submit" class="btn btn-primary">
                  Create Schedule
                </button>
                <a
                  class="btn btn-outline-secondary"
                  href="http://localhost:63342/house-chores-competition/ui/schedules.html"
                >
                  Go to Schedule List
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>
    <!-- Bootstrap JS (optional; for components) -->


<script>
  // ---- Configuration ----
  const GROUP_ID = 1;
  const CHORES_ENDPOINT = `http://127.0.0.1:5000/api/chores?groupId=${GROUP_ID}`;
  const MEMBERS_ENDPOINT = `http://127.0.0.1:5000/api/members?groupId=${GROUP_ID}`;
  const CREATE_SCHEDULE_ENDPOINT = `http://127.0.0.1:5000/api/schedules`;

  // ---- Utilities ----
  const alertContainer = document.getElementById('alert-container');

  function showAlert(message, type = 'success') {
    alertContainer.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>`;
  }

  function clearAlert() {
    alertContainer.innerHTML = '';
  }

  function setTodayOnDateInput(input) {
    // en-CA format yields yyyy-mm-dd for <input type="date">
    const todayStr = new Date().toLocaleDateString('en-CA');
    input.value = todayStr;
  }

  function buildScheduleDateISO(dateOnlyStr) {
    // Build ISO with 09:00 UTC to avoid TZ shifting the date unintentionally
    const [year, month, day] = dateOnlyStr.split('-').map(Number);
    const iso = new Date(Date.UTC(year, month - 1, day, 9, 0, 0)).toISOString();
    return iso;
  }

  // ---- Chore name matching state ----
  // Map normalized chore name => { id, name }
  const choreLookup = new Map();

  function normalizeName(name) {
    return (name || '').trim().toLowerCase();
  }

  function setChoreIdByName(name) {
    const normalized = normalizeName(name);
    const choreIdInput = document.getElementById('choreId'); // hidden
    if (normalized && choreLookup.has(normalized)) {
      choreIdInput.value = choreLookup.get(normalized).id;
    } else {
      choreIdInput.value = '';
    }
  }

  function populateDatalist(options, datalistEl) {
    datalistEl.innerHTML = '';
    options.forEach(({ id, name }) => {
      const opt = document.createElement('option');
      opt.value = name || `Chore #${id}`;
      datalistEl.appendChild(opt);
    });
  }

  // ---- Data loading ----
  async function loadChores() {
    const choreNameInput = document.getElementById('choreName'); // text input
    const choresList = document.getElementById('choresList');   // datalist

    // Disable while loading
    choreNameInput.disabled = true;

    try {
      const res = await fetch(CHORES_ENDPOINT, { method: 'GET', headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error(`Failed to load chores (${res.status})`);
      const data = await res.json();

      const items = Array.isArray(data?.data) ? data.data : [];
      choreLookup.clear();
      items.forEach(chore => {
        const key = normalizeName(chore?.name);
        if (key) choreLookup.set(key, { id: chore.id, name: chore.name });
      });

      populateDatalist(items, choresList);

      choreNameInput.disabled = false; // enable typing (optional)
    } catch (err) {
      showAlert(`Error loading chores: ${err.message}. You can still type a chore name.`, 'warning');
      // Even if fail, allow custom name entry
      choreNameInput.disabled = false;
    }
  }

  async function loadMembers() {
    const select = document.getElementById('memberId');
    select.disabled = true;
    try {
      const res = await fetch(MEMBERS_ENDPOINT, { method: 'GET', headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error(`Failed to load members (${res.status})`);
      const data = await res.json();
      const items = Array.isArray(data?.data) ? data.data : [];

      select.innerHTML = `<option value="">Select a member...</option>`;
      items.forEach(member => {
        const opt = document.createElement('option');
        opt.value = member.id;
        opt.textContent = member.nickname ?? `Member #${member.id}`;
        select.appendChild(opt);
      });
      select.disabled = false;
    } catch (err) {
      select.innerHTML = `<option value="">Error loading members</option>`;
      showAlert(`Error loading members: ${err.message}`, 'danger');
    }
  }

  function getPointValueOrNull() {
    const pointStr = document.getElementById('point').value.trim();
    if (pointStr === '') return null;
    const num = Number(pointStr);
    return Number.isFinite(num) ? num : null;
  }

  // ---- Validation (chore optional) ----
  function validateForm() {
    const dateVal = document.getElementById('scheduleDate').value;
    const memberVal = document.getElementById('memberId').value;
    const errors = [];

    if (!dateVal) errors.push('Please select a schedule date.');
    if (!memberVal) errors.push('Please select a member.');

    return errors;
  }

  // ---- Submit handler ----
  async function handleSubmit(e) {
    e.preventDefault();
    clearAlert();

    const errors = validateForm();
    if (errors.length) {
      showAlert(errors.join('<br/>'), 'warning');
      return;
    }

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;

    try {
      const scheduleDateStr = document.getElementById('scheduleDate').value;
      const scheduleDateISO = buildScheduleDateISO(scheduleDateStr);

      // Chore logic:
      const choreIdVal = document.getElementById('choreId').value;     // hidden, set when name matches
      const choreNameVal = document.getElementById('choreName').value.trim();
      const choreId = choreIdVal ? Number(choreIdVal) : null;
      // Only send newChoreName when NO choreId matched and user typed something
      const newChoreName = !choreId && choreNameVal ? choreNameVal : null;

      const payload = {
        scheduleDate: scheduleDateISO,
        memberId: Number(document.getElementById('memberId').value),
        point: getPointValueOrNull(),
        status: 'Pending',
        comment: document.getElementById('comment').value ?? '',
        // Either choreId or newChoreName (or both null if user left empty)
        choreId,
        newChoreName
      };

      const res = await fetch(CREATE_SCHEDULE_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        let detail = '';
        try {
          const errJson = await res.json();
          detail = errJson?.message || JSON.stringify(errJson);
        } catch (_) {}
        throw new Error(`Create failed (${res.status}). ${detail}`);
      }

      showAlert('Schedule created successfully!', 'success');
      document.getElementById('comment').value = '';
      document.getElementById('point').value = '';
      document.getElementById('choreName').value = '';
      document.getElementById('choreId').value = '';

      // Auto redirect
      window.location.href = 'http://localhost:63342/house-chores-competition/ui/schedules.html';

    } catch (err) {
      showAlert(`Error creating schedule: ${err.message}`, 'danger');
    } finally {
      submitBtn.disabled = false;
    }
  }

  // ---- Wire events ----
  document.addEventListener('DOMContentLoaded', async () => {
    setTodayOnDateInput(document.getElementById('scheduleDate'));

    // Listen to user typing and resolve choreId match
    const choreNameInput = document.getElementById('choreName');
    choreNameInput.addEventListener('input', (e) => {
      setChoreIdByName(e.target.value);
    });

    await Promise.all([loadChores(), loadMembers()]);

    document.getElementById('schedule-form').addEventListener('submit', handleSubmit);
  });
</script>

</body>
</html>
