<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weekly Chore Schedule</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .body {
      font-family: Arial, sans-serif;
    }
    .card-title {
      font-size: 13px;
    }
    .card-text {
      font-size: 12px;
    }
    .schedule-card {
      margin-bottom: 10px;
      cursor: pointer;
    }
    .schedule-card:active {
      /* Effect: change color and scale down slightly */
      background-color: #b6d1fa;
      transform: scale(0.95);
    }
    .status-Pending { background-color: #fffff; }
    .status-InProgress { color: #015985; font-weight: bold;}
    .status-Done { color: #06800e; font-weight: bold;}
    .status-FullyReviewed { background-color: #e2e3e5; font-weight: bold;}

    body {
      background-color: #f8f9fa;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-weight: bold;
      color: #343a40;
    }
    .day-column {
      min-height: 300px;
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .schedule-card {
      margin-bottom: 12px;
      border-left: 5px solid transparent;
    }
  </style>
</head>
<body class="container py-4">
  <h5>Weekly Chore Schedule</h5>
  <div class="d-flex justify-content-end mb-3">
    <a
      class="btn btn-outline-secondary"
      href="http://localhost:63342/house-chores-competition/ui/house_chores.html" >      New House Chore
    </a>
    &nbsp;
    <a href="http://localhost:63342/house-chores-competition/ui/new_schedules.html" class="btn btn-primary">
      Add New Schedule
    </a>
  </div>
  <div class="offcanvas offcanvas-end" id="scheduleDrawer" tabindex="-1" aria-labelledby="scheduleDrawerLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="scheduleDrawerLabel">Edit Schedule</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <form id="editScheduleForm">
        <div class="mb-3">
          <label for="editChore" class="form-label">Chore</label>
          <select class="form-select" id="editChore"></select>
        </div>
        <div class="mb-3">
          <label for="editMember" class="form-label">Member</label>
          <select class="form-select" id="editMember"></select>
        </div>
        <div class="mb-3">
          <label for="editStatus" class="form-label">Status</label>
          <select class="form-select" id="editStatus">
            <option value="Pending">Pending</option>
            <option value="InProgress">In Progress</option>
            <option value="Done">Done</option>
            <option value="FullyReviewed">Fully Reviewed</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="editComment" class="form-label">Comment</label>
          <textarea class="form-control" id="editComment" rows="3"></textarea>
        </div>
        <button id="saveChangesBtn" type="button" class="btn btn-primary">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Days of the week -->
  <div class="row text-center fw-bold mb-3">
    <div class="col">Monday</div>
    <div class="col">Tuesday</div>
    <div class="col">Wednesday</div>
    <div class="col">Thursday</div>
    <div class="col">Friday</div>
    <div class="col">Saturday</div>
    <div class="col">Sunday</div>
  </div>

  <!-- Schedule grid -->
  <div class="row g-3" id="scheduleRow">
    <div class="col day-column m-1" id="day-1"></div>
    <div class="col day-column m-1" id="day-2"></div>
    <div class="col day-column m-1" id="day-3"></div>
    <div class="col day-column m-1" id="day-4"></div>
    <div class="col day-column m-1" id="day-5"></div>
    <div class="col day-column m-1" id="day-6"></div>
    <div class="col day-column m-1" id="day-0"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- State ---
    let currentScheduleId = null;

    // --- Fetch and render schedules ---
    async function fetchSchedules() {
      try {
        const response = await fetch('http://127.0.0.1:5000/api/schedules?groupId=1');
        if (!response.ok) throw new Error(`Failed to fetch schedules (${response.status})`);
        const data = await response.json();
        renderSchedules(data.data || []);
      } catch (err) {
        console.error('Error fetching schedules:', err);
      }
    }

    function renderSchedules(schedules) {
      // Clear existing columns
      document.querySelectorAll('#scheduleRow .col').forEach(col => (col.innerHTML = ''));

      schedules.forEach(sch => {
        const date = new Date(sch.scheduleDate);
        const dayOfWeek = date.getDay(); // Sunday=0
        const cell = document.getElementById(`day-${dayOfWeek}`);
        if (!cell) return;

        const card = document.createElement('div');
        card.className = `card schedule-card shadow rounded`;
        card.dataset.scheduleId = sch.id;

        // âœ… Set left border color to member.hex (fallback to gray)
        const hex = sch.member?.hex || '#999999';
        card.style.borderLeftColor = hex;

        card.innerHTML = `
          <div class="card-body p-2">
            <h6 class="card-title mb-1">${sch.chore?.name ?? 'Unknown chore'}</h6>
            <p class="card-text mb-1">
              <small>${sch.member?.nickname ?? 'Unknown member'}</small></br>
              <small class=status-${sch.status}>${sch.status}</small>
            </p>
            <small class="text-muted">${sch.comment || ''}</small>
          </div>
        `;
        cell.appendChild(card);

        // Attach click listener right after creation
        card.addEventListener('click', () => openScheduleDrawer(sch.id));
      });
    }

    // --- Open drawer and populate form ---
    async function openScheduleDrawer(scheduleId) {
      try {
        const [scheduleRes, choresRes, membersRes] = await Promise.all([
          fetch(`http://127.0.0.1:5000/api/schedules/${scheduleId}`),
          fetch(`http://127.0.0.1:5000/api/chores?groupId=1`),
          fetch(`http://127.0.0.1:5000/api/members?groupId=1`)
        ]);

        if (!scheduleRes.ok || !choresRes.ok || !membersRes.ok) {
          throw new Error('Failed to load data');
        }

        const schedule = await scheduleRes.json();
        const chores = await choresRes.json();
        const members = await membersRes.json();

        const scheduleData = schedule.data;
        const choresData = chores.data || [];
        const membersData = members.data || [];

        // Populate selects
        const choreSelect = document.getElementById('editChore');
        choreSelect.innerHTML = choresData.map(chore =>
          `<option value="${chore.id}" ${chore.id === scheduleData.chore.id ? 'selected' : ''}>
            ${chore.name}
          </option>`
        ).join('');

        const memberSelect = document.getElementById('editMember');
        // Use "nickname" consistently
        memberSelect.innerHTML = membersData.map(member =>
          `<option value="${member.id}" ${member.id === scheduleData.member.id ? 'selected' : ''}>
            ${member.nickname}
          </option>`
        ).join('');

        // Other fields
        document.getElementById('editStatus').value = scheduleData.status;
        document.getElementById('editComment').value = scheduleData.comment || '';

        // Store id for Save button
        currentScheduleId = scheduleId;

        // Show offcanvas
        const drawerElement = document.getElementById('scheduleDrawer');
        const drawer = new bootstrap.Offcanvas(drawerElement);
        drawer.show();
      } catch (err) {
        console.error('Error loading schedule details:', err);
      }
    }

    // --- Patch schedule via button click ---
    async function updateSchedule(scheduleId) {
      const saveBtn = document.getElementById('saveChangesBtn');
      const payload = {
        choreId: Number(document.getElementById('editChore').value),
        memberId: Number(document.getElementById('editMember').value),
        status: document.getElementById('editStatus').value,
        comment: document.getElementById('editComment').value
      };

      try {
        // Prevent double clicks
        saveBtn.disabled = true;

        const response = await fetch(`http://127.0.0.1:5000/api/schedules/${scheduleId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          let detail = '';
          try { detail = (await response.json())?.message ?? ''; } catch {}
          throw new Error(`Failed to update schedule (${response.status}). ${detail}`);
        }

<!--        alert('Schedule updated successfully!');-->

        // Close drawer
        const drawerElement = document.getElementById('scheduleDrawer');
        const offcanvasInstance = bootstrap.Offcanvas.getInstance(drawerElement);
        if (offcanvasInstance) offcanvasInstance.hide();

        // Refresh UI
        await fetchSchedules();
      } catch (err) {
        console.error('Error updating schedule:', err);
        alert(`Error updating schedule: ${err.message}`);
      } finally {
        saveBtn.disabled = false;
      }
    }

    // --- Wire up (NO form submit) ---
    document.addEventListener('DOMContentLoaded', () => {
      // Initial load
      fetchSchedules();

      // Save button click
      const saveBtn = document.getElementById('saveChangesBtn');
      if (saveBtn) {
        saveBtn.addEventListener('click', () => {
          console.log('Save Changes clicked. currentScheduleId=', currentScheduleId);
          if (!currentScheduleId) {
            alert('No schedule selected.');
            return;
          }
          updateSchedule(currentScheduleId);
        });
      } else {
        console.error('Save Changes button not found. Ensure id="saveChangesBtn" exists and script runs after markup.');
      }
    });
  </script>

</body>
</html>